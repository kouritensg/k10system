<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K10 Admin - Pack Bank</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

    <nav class="bg-white shadow-sm mb-8">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">K10 Manager Portal</h1>
            <div class="space-x-4">
                <a href="admin.html" class="text-gray-600 hover:text-blue-600 font-medium">Inventory</a>
                <a href="admin-events.html" class="text-gray-600 hover:text-blue-600 font-medium">Events</a>
                <a href="admin-customers.html" class="text-gray-600 hover:text-blue-600 font-medium">Customers</a>
                <a href="admin-storage.html" class="text-blue-600 font-bold border-b-2 border-blue-600 pb-1">Pack Bank</a>
                <button id="logout-btn" class="text-red-600 font-semibold ml-4">Logout</button>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4">
        
        <div class="bg-white p-6 rounded-lg shadow-sm mb-8 border-l-4 border-yellow-500">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Manage Customer Packs</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="relative">
                    <label class="text-xs text-gray-500 block mb-1 font-bold">STEP 1: Find Customer</label>
                    <input type="text" id="cust-search" placeholder="Type name to search..." class="w-full p-2 border rounded" autocomplete="off">
                    <div id="cust-results" class="absolute z-10 w-full bg-white shadow-lg border rounded mt-1 hidden max-h-40 overflow-y-auto"></div>
                    <input type="hidden" id="selected-cust-id">
                </div>

                <div>
                    <label class="text-xs text-gray-500 block mb-1 font-bold">STEP 2: Select Event Source</label>
                    <select id="event-select" class="w-full p-2 border rounded bg-gray-50 text-gray-600" disabled>
                        <option value="">(Select a customer first)</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-1">* Only events they joined appear here.</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-t pt-4">
                <div>
                    <label class="text-xs text-gray-500 block mb-1">Pack Type / Set</label>
                    <input type="text" id="pack-type" value="Standard Booster" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="text-xs text-gray-500 block mb-1">Quantity</label>
                    <input type="number" id="pack-qty" value="1" min="1" class="w-full p-2 border rounded font-bold text-center">
                </div>
                <div class="flex items-end gap-2">
                    <button onclick="depositPacks()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow">+ Deposit</button>
                    <button onclick="withdrawPacks()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded shadow">- Withdraw</button>
                </div>
            </div>
        </div>

        <h3 class="text-xl font-bold text-gray-700 mb-4">Current Banked Packs</h3>
        <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-12">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 border-b">
                    <tr>
                        <th class="p-4">Customer</th>
                        <th class="p-4">Game / Set</th>
                        <th class="p-4">Balance</th>
                        <th class="p-4">Last Updated</th>
                        <th class="p-4">History</th>
                    </tr>
                </thead>
                <tbody id="storage-table"></tbody>
            </table>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 overflow-hidden flex flex-col max-h-[80vh]">
            <div class="bg-gray-800 px-6 py-4 flex justify-between items-center text-white">
                <h3 class="font-bold text-lg">Transaction History</h3>
                <button onclick="closeHistory()" class="text-2xl hover:text-gray-300">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <h4 id="history-cust-name" class="font-bold text-gray-700 mb-4 text-lg"></h4>
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-left text-gray-500 border-b">
                            <th class="pb-2">Date</th>
                            <th class="pb-2">Action</th>
                            <th class="pb-2">Source / Event</th>
                        </tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://k10system.onrender.com/api';
        let token = localStorage.getItem('k10_token');

        document.addEventListener('DOMContentLoaded', () => {
            if (!token) window.location.href = 'admin.html';
            loadStorage();
            
            const searchInput = document.getElementById('cust-search');
            searchInput.addEventListener('input', async (e) => {
                const q = e.target.value;
                if (q.length < 2) return;
                try {
                    const res = await fetch(`${API_URL}/customers/search?q=${q}`);
                    const customers = await res.json();
                    const resultsDiv = document.getElementById('cust-results');
                    resultsDiv.innerHTML = customers.map(c => `
                        <div class="p-2 hover:bg-blue-50 cursor-pointer border-b" 
                             onclick="selectCustomer(${c.id}, '${c.name}')">
                            <span class="font-bold">${c.name}</span> <span class="text-xs text-gray-500">(${c.contact_info})</span>
                        </div>
                    `).join('');
                    resultsDiv.classList.remove('hidden');
                } catch(err) {}
            });
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target)) document.getElementById('cust-results').classList.add('hidden');
            });
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('k10_token');
                window.location.href = 'admin.html';
            });
        });

        async function selectCustomer(id, name) {
            document.getElementById('selected-cust-id').value = id;
            document.getElementById('cust-search').value = name;
            document.getElementById('cust-results').classList.add('hidden');
            
            const eventSelect = document.getElementById('event-select');
            eventSelect.innerHTML = '<option>Loading history...</option>';
            eventSelect.disabled = true;

            try {
                const res = await fetch(`${API_URL}/customers/${id}/recent-events`);
                const events = await res.json();
                eventSelect.innerHTML = events.length ? 
                    '<option value="">-- Select Event Source --</option>' + events.map(e => `<option value="${e.id}" data-game="${e.game_title}">${e.title} (${new Date(e.event_date).toLocaleDateString()})</option>`).join('') :
                    '<option value="">No recent events found</option>';
                eventSelect.disabled = false;
            } catch(err) {}
        }

        async function depositPacks() {
            const custId = document.getElementById('selected-cust-id').value;
            const eventSelect = document.getElementById('event-select');
            const eventId = eventSelect.value;
            if (!custId) return alert("Select a customer.");
            if (!eventId) return alert("Select the Event they played in.");

            const gameTitle = eventSelect.options[eventSelect.selectedIndex].getAttribute('data-game');
            const qty = parseInt(document.getElementById('pack-qty').value);
            await sendUpdate(custId, gameTitle, qty, eventId);
        }

        async function withdrawPacks() {
            const custId = document.getElementById('selected-cust-id').value;
            if (!custId) return alert("Select a customer.");
            
            const eventSelect = document.getElementById('event-select');
            let gameTitle = "One Piece";
            if(eventSelect.selectedIndex > 0) gameTitle = eventSelect.options[eventSelect.selectedIndex].getAttribute('data-game');
            else {
                gameTitle = prompt("Which game? (One Piece, Hololive, etc.)", "One Piece");
                if(!gameTitle) return;
            }
            const qty = parseInt(document.getElementById('pack-qty').value);
            await sendUpdate(custId, gameTitle, -qty, null);
        }

        async function sendUpdate(custId, gameTitle, amount, eventId) {
            const packType = document.getElementById('pack-type').value || 'Standard Booster';
            try {
                const res = await fetch(`${API_URL}/storage/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customer_id: custId, game_title: gameTitle, pack_type: packType, change_amount: amount, event_id: eventId })
                });
                if (res.ok) { alert("Updated!"); loadStorage(); }
                else { const err = await res.json(); alert("Error: " + err.error); }
            } catch (err) { alert("Connection Failed"); }
        }

        async function loadStorage() {
            const res = await fetch(`${API_URL}/storage`);
            const rows = await res.json();
            document.getElementById('storage-table').innerHTML = rows.map(r => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-bold text-gray-800">${r.name}</td>
                    <td class="p-4">
                        <span class="text-xs font-bold text-blue-600 uppercase bg-blue-50 px-2 py-1 rounded">${r.game_title}</span>
                        <span class="text-sm ml-2">${r.pack_type}</span>
                    </td>
                    <td class="p-4 font-bold text-xl text-green-700">${r.quantity}</td>
                    <td class="p-4 text-xs text-gray-400">${new Date(r.last_updated).toLocaleDateString()}</td>
                    <td class="p-4">
                        <button onclick="viewHistory(${r.customer_id}, '${r.name}')" class="text-sm text-blue-600 hover:underline">View Log</button>
                    </td>
                </tr>
            `).join('');
        }

        async function viewHistory(custId, name) {
            document.getElementById('history-cust-name').innerText = name + "'s History";
            document.getElementById('history-modal').classList.remove('hidden');
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4">Loading...</td></tr>';
            
            try {
                const res = await fetch(`${API_URL}/storage/history/${custId}`);
                const logs = await res.json();
                
                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">No history found.</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.map(l => {
                    // Logic to display Event Name AND Date if available
                    let sourceHtml = 'Pickup / Withdrawal';
                    if (l.event_name) {
                        const eventDate = new Date(l.event_date).toLocaleDateString();
                        sourceHtml = `üèÜ ${l.event_name} <span class="text-xs text-gray-400 font-normal">(${eventDate})</span>`;
                    }

                    return `
                    <tr class="border-b">
                        <td class="py-2 text-gray-500 text-xs">
                            ${new Date(l.transaction_date).toLocaleDateString()} 
                            ${new Date(l.transaction_date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </td>
                        <td class="py-2 font-bold ${l.amount > 0 ? 'text-green-600' : 'text-red-500'}">
                            ${l.amount > 0 ? '+' : ''}${l.amount} Packs
                        </td>
                        <td class="py-2 text-sm text-gray-600 font-semibold">
                            ${sourceHtml}
                        </td>
                    </tr>
                    `;
                }).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-500">Error loading history.</td></tr>';
            }
        }
        function closeHistory() { document.getElementById('history-modal').classList.add('hidden'); }
    </script>
</body>
</html>
